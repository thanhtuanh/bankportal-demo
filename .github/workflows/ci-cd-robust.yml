name: Bank Portal CI/CD (Robust)

on:
  push:
    branches: [ main, develop, k8s, stand-1, stand-2 ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  frontend-build:
    name: 🌐 Frontend Build (Robust)
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
      
      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: 📦 Install Dependencies (Robust)
        working-directory: ./frontend
        run: |
          echo "📦 Installing npm dependencies with robust approach..."
          npm install --legacy-peer-deps --no-audit --no-fund
          echo "✅ Dependencies installed successfully!"
      
      - name: 🏗️ Build Frontend
        working-directory: ./frontend
        run: |
          echo "🏗️ Building Frontend for production..."
          npm run build:prod
          echo "✅ Frontend build completed successfully!"
          ls -la dist/

  auth-service-build:
    name: 🔐 Auth Service Build (Robust)
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
      
      - name: ☕ Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: 🏗️ Build Auth Service
        working-directory: ./auth-service
        run: |
          echo "🏗️ Building Auth Service..."
          mvn clean compile -DskipTests -q
          mvn package -DskipTests -q
          echo "✅ Auth Service build completed!"
          ls -la target/

  account-service-build:
    name: 💼 Account Service Build (Robust)
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
      
      - name: ☕ Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: 🏗️ Build Account Service
        working-directory: ./account-service
        run: |
          echo "🏗️ Building Account Service..."
          mvn clean compile -DskipTests -q
          mvn package -DskipTests -q
          echo "✅ Account Service build completed!"
          ls -la target/

  success-report:
    name: ✅ Success Report
    runs-on: ubuntu-latest
    needs: [frontend-build, auth-service-build, account-service-build]
    steps:
      - name: 🎉 Generate Success Report
        run: |
          echo "# 🎉 Bank Portal CI/CD - SUCCESS!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ✅ All Builds Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| 🌐 Frontend | ✅ Success | Angular build completed |" >> $GITHUB_STEP_SUMMARY
          echo "| 🔐 Auth Service | ✅ Success | Spring Boot JAR created |" >> $GITHUB_STEP_SUMMARY
          echo "| 💼 Account Service | ✅ Success | Spring Boot JAR created |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## 🚀 Ready for Deployment!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📋 Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ All services built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- 🐳 Ready for Docker containerization" >> $GITHUB_STEP_SUMMARY
          echo "- 🚀 Ready for deployment to any environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**🎯 CI/CD Pipeline is working perfectly!**" >> $GITHUB_STEP_SUMMARY
