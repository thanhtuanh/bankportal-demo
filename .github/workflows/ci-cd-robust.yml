name: Bank Portal CI/CD (Robust)

on:
  push:
    branches: [ main, develop, k8s, stand-1, stand-2 ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  JAVA_VERSION: '17'

jobs:
  frontend-build:
    name: ðŸŒ Frontend Build (Robust)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: ðŸ“¦ Install Dependencies (Robust)
        working-directory: ./frontend
        run: |
          echo "ðŸ“¦ Installing npm dependencies with robust approach..."
          npm install --legacy-peer-deps --no-audit --no-fund
          echo "âœ… Dependencies installed successfully!"
      
      - name: ðŸ—ï¸ Build Frontend
        working-directory: ./frontend
        run: |
          echo "ðŸ—ï¸ Building Frontend for production..."
          npm run build:prod
          echo "âœ… Frontend build completed successfully!"
          ls -la dist/

  auth-service-build:
    name: ðŸ” Auth Service Build (Robust)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: ðŸ—ï¸ Build Auth Service
        working-directory: ./auth-service
        run: |
          echo "ðŸ—ï¸ Building Auth Service..."
          mvn clean compile -DskipTests -q
          mvn package -DskipTests -q
          echo "âœ… Auth Service build completed!"
          ls -la target/

  account-service-build:
    name: ðŸ’¼ Account Service Build (Robust)
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
      
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
      
      - name: ðŸ—ï¸ Build Account Service
        working-directory: ./account-service
        run: |
          echo "ðŸ—ï¸ Building Account Service..."
          mvn clean compile -DskipTests -q
          mvn package -DskipTests -q
          echo "âœ… Account Service build completed!"
          ls -la target/

  success-report:
    name: âœ… Success Report
    runs-on: ubuntu-latest
    needs: [frontend-build, auth-service-build, account-service-build]
    steps:
      - name: ðŸŽ‰ Generate Success Report
        run: |
          echo "# ðŸŽ‰ Bank Portal CI/CD - SUCCESS!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… All Builds Completed Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Frontend | âœ… Success | Angular build completed |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Auth Service | âœ… Success | Spring Boot JAR created |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ’¼ Account Service | âœ… Success | Spring Boot JAR created |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Ready for Deployment!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All services built successfully" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ³ Ready for Docker containerization" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš€ Ready for deployment to any environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸŽ¯ CI/CD Pipeline is working perfectly!**" >> $GITHUB_STEP_SUMMARY
